# 快速开始 - 批量编辑 FlowModel

## 使用方法

批量编辑 FlowModel 已经自动集成到插件中，无需额外配置即可使用。

## 在界面中使用

### 1. 添加批量编辑按钮

在表格、甘特图或地图区块中：
1. 点击"配置操作"
2. 选择"批量编辑"按钮
3. 按钮会自动添加到操作栏

### 2. 配置批量编辑

点击按钮设置图标，进入配置面板：

#### 按钮设置
- 修改按钮标题
- 设置提示文本
- 选择图标
- 设置按钮样式

#### 批量编辑操作设置

**二次确认**
- 开启/关闭确认弹窗
- 自定义确认标题
- 自定义确认内容（支持变量）

**编辑数据范围**
- 选中：仅编辑选中的记录
- 全部：编辑全表数据

**字段赋值**
- 选择要编辑的字段
- 为每个字段设置新值
- 支持使用变量表达式

### 3. 使用批量编辑

#### 编辑选中行
1. 在表格中选中一行或多行
2. 点击"批量编辑"按钮
3. 如果启用了二次确认，会弹出确认对话框
4. 确认后执行批量编辑
5. 成功后显示提示并刷新数据

#### 编辑全表
1. 在配置中选择"全部"编辑模式
2. 点击"批量编辑"按钮
3. 确认后会编辑表中所有记录
4. 成功后显示提示并刷新数据

## 配置示例

### 示例 1：批量修改状态

**场景**：将选中的文章状态改为"已发布"

配置：
- 编辑数据范围：选中
- 字段赋值：
  - status = "published"
  - publishedAt = {{$now}}

### 示例 2：批量清空字段

**场景**：清空所有记录的备注字段

配置：
- 编辑数据范围：全部
- 字段赋值：
  - notes = null

### 示例 3：批量更新关联

**场景**：将选中订单的负责人改为当前用户

配置：
- 编辑数据范围：选中
- 字段赋值：
  - assignedTo = {{$user.id}}

## 变量支持

批量编辑支持在字段赋值中使用变量表达式：

### 系统变量
- `{{$now}}` - 当前时间
- `{{$user.id}}` - 当前用户ID
- `{{$user.name}}` - 当前用户名称

### 上下文变量
- 区块筛选条件
- 区块参数
- URL 参数

## 权限控制

批量编辑需要以下权限：
- 数据表的 `update` 权限
- UI 配置权限（配置按钮）

如果用户没有权限：
- 按钮会显示权限提示
- 点击按钮时会显示错误信息

## 注意事项

### 1. 选中行模式
- 必须先选中至少一行才能执行
- 未选中时会提示"请选择要编辑的记录"

### 2. 全表模式
- 会编辑表中的所有记录，请谨慎使用
- 建议启用二次确认

### 3. 字段配置
- 至少配置一个字段的赋值
- 未配置时会提示"未配置字段赋值"

### 4. 数据源
- 自动识别当前区块的数据源
- 支持多数据源场景

## 与原版功能的区别

### FlowModel 版本优势

1. **统一架构**：使用与其他操作一致的 FlowModel 架构
2. **变量支持**：可以在字段赋值中使用变量表达式
3. **更好的类型提示**：开发时有完整的 TypeScript 类型提示
4. **配置复用**：配置参数可以被其他 Flow 复用

### 兼容性

- 与原版批量编辑功能完全兼容
- 可以与原版功能共存
- 数据格式和 API 调用方式一致

## 故障排查

### 问题 1：按钮不可用
- 检查是否有 update 权限
- 检查区块是否正确加载数据

### 问题 2：未选中记录提示
- 在选中模式下，必须先选中行
- 或切换到"全部"模式

### 问题 3：字段赋值不生效
- 检查字段是否配置正确
- 检查变量表达式是否正确
- 查看浏览器控制台是否有错误

### 问题 4：权限错误
- 确认用户有数据表的 update 权限
- 联系管理员分配权限

## 开发者指南

### 扩展批量编辑

如果需要扩展批量编辑功能：

```typescript
import { BulkEditActionModel } from '@nocobase/plugin-action-bulk-edit/client';

// 创建自定义批量编辑
class CustomBulkEditActionModel extends BulkEditActionModel {
  // 自定义逻辑
}

// 注册自定义模型
app.flowEngine.registerModels({
  CustomBulkEditActionModel,
});
```

### 添加配置步骤

```typescript
BulkEditActionModel.registerFlow({
  key: 'assignSettings',
  steps: {
    // 添加新的配置步骤
    customStep: {
      title: tExpr('Custom step'),
      uiSchema: {
        // 步骤的 UI Schema
      },
    },
  },
});
```

### 自定义执行逻辑

```typescript
BulkEditActionModel.registerFlow({
  key: 'apply',
  steps: {
    apply: {
      async handler(ctx, params) {
        // 在这里添加自定义逻辑
        // ...
      },
    },
  },
});
```

## 更多资源

- [完整实现文档](./IMPLEMENTATION.md)
- [技术文档](./README.md)
- [NocoBase 官方文档](https://docs.nocobase.com)
- [FlowModel 架构文档](../../../../core/client/src/flow/README.md)
