# 概述

工作流插件是一个编排和配置自动化流程的强大工具，业界通常称为业务流程管理（BPM）工具。常用于基于数据模型的业务流程设计与编排，通过触发条件与执行流程节点编排实现业务流程的自动化流转。基于工作流插件，可以在 UI 界面上完成大部分常见业务处理的编排，而无需通过修改代码的传统方式来开发或升级系统中的业务流程变更。

在 NocoBase 中，工作流可以解决几大场景的问题：

* 数据自动化处理：比如在数据表中新增一条数据后，自动按预定流程处理数据，如计算触发数据后更新关联数据等。
* 人工介入的业务流程：当业务流程不能完全自动化决策时，可以通过人工类型的节点，将部分决策权交给人工处理，比如审批、复核等。人工处理的结果提交以后，再继续执行后续流程。
* 与外部系统连接：可以通过请求节点（或扩展各类调用第三方功能的节点）调用外部系统的 API 接口，实现和外部系统的数据交互。

一个典型的工作流如下图所示：

<figure>
  <img alt="工作流示例" src="https://github.com/nocobase/nocobase/assets/525658/7b8fd56c-9aa1-4027-81df-d8c25c6bc80f" width="960">
</figure>

## 基本概念

工作流将传统通过代码实现的业务逻辑，抽象为作为入口的触发器和具体执行业务的流程节点，通过触发器控制执行时机，通过节点控制流程和对数据进行相关操作，以实现基于数据模型的业务状态自动化流转逻辑的编排。

工作流的内部模型有几个基础实体概念：

* **工作流**：用于定义流程的基本信息，包括名称、触发器和启用状态等。
* **节点**：节点是工作流内的具体执行的指令单元，正如函数的函数体与参数，节点类型代表了指令，节点配置代表了指令参数，一个工作流中可以有任意多个节点，节点之间通过上下游关系组成完整的执行流程。
* **执行计划**：执行计划是工作流触发后的具体执行对象，也称为执行记录或执行历史，包含了执行的状态、触发上下文数据等信息。其中针对每个节点也有对应的执行结果，包含了节点执行后的状态和结果数据信息。

关系如下图所示：

<figure>
  <img alt="工作流模型" src="https://github.com/nocobase/nocobase/assets/525658/8256c233-f7bf-441f-9b8c-0ab4d33711a1" width="471">
</figure>

### 触发器简介

每个工作流都包含一个触发器，当应用在运行周期中，由于人为操作或自动事件满足触发条件时，工作流将会被触发执行。已实现的触发器包括：表单、数据表、定时任务三个类型（参考 [触发器](./triggers) 相关介绍）。比如用户提交一个表单，或者数据表中的数据由于用户操作或程序调用发生变化，或者定时任务到达执行时间，都会触发对应的工作流执行。

### 节点及执行状态

节点类型（指令）与节点配置类似与函数与参数的关系，节点配置会作为对应指令所需的参数。节点执行后会产生一个执行状态和一个结果数据，结果数据可以在下游节点中被引用，状态则会决定后续流程是否继续执行。通常情况下，节点执行成功后，会继续执行下一个节点，直到所有节点依次执行完成，或者被中断。当遇到流程控制相关节点时，如分支、循环、并行、延时等，会根据节点配置的条件，以及运行时的上下文数据，决定下一个节点的执行流向。

每个节点执行后可能产生的状态如下表：

| 状态 | 是否是终态 | 是否提前终止 | 含义 |
| --- | :---: | :---: | --- |
| 等待 | 否 | 否 | 节点要求暂停，等待进一步输入或回调再继续 |
| 完成 | 是 | 否 | 未遇到任何问题，执行成功，继续执行下一个节点直至结束。 |
| 失败 | 是 | 是 | 由于未满足节点配置，导致失败。 |
| 出错 | 是 | 是 | 节点遇到未捕获的程序错误，提前结束。 |
| 取消 | 是 | 是 | 等待中的节点被流程管理者从外部取消执行，提前结束 |
| 拒绝 | 是 | 是 | 在人工处理的节点中，被人工拒绝不再继续后续流程 |

除等待状态外，其他状态都是节点执行的终态，只有终态是“完成”的状态，才会继续执行，否则都会提前终止整个流程的执行。当节点处在分支流程中时（并行分支、条件判断、循环等），节点执行产生的终态会由开启分支的节点接管处理，并以此类推决定整个流程的流转。

### 执行计划与历史记录

当主流程分支中的节点全部都以“完成”状态执行到流程终点时，整个执行计划将以“完成”状态结束。当主流程分支中的节点出现“失败”、“出错”、“取消”、“拒绝”等终态时，整个执行计划将以对应的状态**提前终止**。当主流程分支中的节点出现“等待”状态时，整个执行计划将暂停执行，但仍显示“执行中”的状态，直到等待的节点被恢复后继续执行。不同的节点类型对等待状态的处理方式不同，比如人工节点需要等待人工处理，而延时节点需要等待时间到达后继续执行。

执行计划的状态如下表：

| 状态 | 对应主流程最后执行的节点状态 | 含义 |
| --- | --- | --- |
| 排队中 | - | 流程已触发并生成执行计划，排队等待调度器安排执行 |
| 进行中 | 等待 | 节点要求暂停，等待进一步输入或回调再继续 |
| 完成 | 完成 | 未遇到任何问题，所有节点按预期逐个执行完成。 |
| 失败 | 失败 | 由于未满足节点配置，导致失败。 |
| 出错 | 出错 | 节点遇到未捕获的程序错误，提前结束。 |
| 取消 | 取消 | 等待中的节点被流程管理者从外部取消执行，提前结束 |
| 拒绝 | 拒绝 | 在人工处理的节点中，被人工拒绝不再继续后续流程 |

在一个工作流被触发执行后，可以通过工作流的执行历史查看对应的执行记录细节，以检查执行是否正常，或者查看节点的执行结果，每个已执行的节点都可以查看对应的执行状态和结果数据。如下例：

<figure>
  <img alt="执行流程记录：流程全图" src="https://github.com/nocobase/nocobase/assets/525658/237087f0-3fd7-4ae4-969f-acee3857bd10" width="959">
  <figcaption>执行流程记录：流程全图</figcaption>
</figure>

<figure>
  <img alt="执行流程记录：节点信息" src="https://github.com/nocobase/nocobase/assets/525658/0f80beee-77db-4c64-9bff-9044a98b3107" width="1139">
  <figcaption>执行流程记录：节点信息</figcaption>
</figure>

<figure>
  <img alt="执行流程记录：多次执行的节点信息" src="https://github.com/nocobase/nocobase/assets/525658/75f746ef-c0dd-48b7-9248-d87470120ebf" width="669">
  <figcaption>执行流程记录：多次执行的节点信息</figcaption>
</figure>

## 进阶理解

### 工作流的版本与启停状态

在已配置的工作流触发至少一次以后，如希望修改工作流的配置或其中的节点，需要通过创建新版本后再修改，这样同时也保证了当回顾已触发过的工作流历史执行记录时不受未来修改的影响。

在工作流的配置页面，可以在右上角的版本菜单查看已有的工作流版本，在其右侧的更多操作（“…”）菜单中，可以选择基于当前查看的版本复制到新版本。复制到新版本之后，点击“启用”/“停用”开关，将对应版本切换到启用状态后，新的工作流版本将会生效。

如需重新选择旧版本，从版本菜单中切换后，再次点击“启用”/“停用”开关切换至启用状态后，当前查看的版本将生效，后续触发将执行对应版本的流程。

当需要停用工作流时，点击“启用”/“停用”开关切换至停用状态后，该工作流将不再会被触发。

### 使用变量

变量是在工作流触发后以及按节点逐个执行时，在每个节点配置中可以使用的前序数据。例如可以将数据表触发工作流的数据，使用在后续的更新数据操作中，用以达成通过关联关系更新关联数据的结果。一个简单的场景，就是当用户对一个商品购买下单时，通过订单对应的商品，更新商品的库存为之前的库存 -1。

<figure>
  <img alt="商品下单更新商品库存" src="https://github.com/nocobase/nocobase/assets/525658/fefbb0cc-e9ac-4f34-86a7-201289786bb5" width="678">
  <figcaption>图中两处“x”按钮为选择变量</figcaption>
</figure>

通过变量之间的数据关联关系，可以在流程的执行中将相关的信息有机地组织起来，达到业务状态按预期流转的目标。

流程中可以作为变量的数据分为以下几类：

* 触发上下文数据：表单触发、数据表触发等情况下，单行数据对象可以被所有节点使用。
* 上游节点数据：流程进行到任意节点时，之前已完成的节点的结果数据。
* 局域变量：当节点处在一些特殊分支结构内时，可以使用对应分支内特有的局域变量，例如循环结构中可以使用每轮循环的数据对象。
* 系统变量：一些内置的系统参数，如当前时间等。

变量的内部是一个 JSON 结构，由于很多变量是基于 NocoBase 的数据表结构的，关系数据将会以对象属性的结构按层级组成。当关系数据是对多的结构时，变量可能会是一个数组。选择变量在大多数时候会选到最后一层属性，属性通常是简单数据类型，如数字、字符串等。但当变量层级中有数组时，末级的属性也会被映射成一个数组，只有对应的节点支持数组的情况下，才能正确处理数组数据。例如在运算节点中，一些计算引擎有专门处理数组的函数，又比如在循环节点中，循环对象也可以直接选择一个数组。

## 高级配置

### 自动删除历史记录

当工作流的触发较为频繁时，可以通过配置自动删除历史记录来减少干扰，同时也将降低数据库的存储压力。

同样在工作流的新建和编辑弹窗中可以配置对应流程是否自动删除历史记录：

<figure>
  <img alt="自动删除历史记录配置" src="https://github.com/nocobase/nocobase/assets/525658/c108a19b-7e5c-4c21-a8dc-03a9274e499c" width="673">
</figure>

自动删除可以根据执行结果的状态来进行配置，大部分情况下，建议仅勾选“完成”状态，这样可以保留执行失败的记录，以便后续排查问题。

建议在调试工作流时不要开启自动删除历史记录，以便通过历史记录来检查工作流的执行逻辑是否符合预期。
