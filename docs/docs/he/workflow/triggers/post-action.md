---
pkg: '@nocobase/plugin-workflow-action-trigger'
---
:::tip
מסמך זה תורגם על ידי בינה מלאכותית. לכל אי דיוק, אנא עיין ב[גרסה האנגלית](/en)
:::


# אירוע לאחר פעולה

## מבוא

כל שינויי הנתונים שמבצעים משתמשים במערכת מתבצעים בדרך כלל באמצעות פעולה, שלרוב באה לידי ביטוי בלחיצה על כפתור. כפתור זה יכול להיות כפתור שליחה בטופס, או כפתור פעולה בבלוק נתונים. אירוע לאחר פעולה משמש לקשירת תהליכי עבודה רלוונטיים לפעולות של כפתורים אלה, כך שתהליך ספציפי יופעל לאחר השלמת פעולת המשתמש בהצלחה.

לדוגמה, בעת הוספה או עדכון של נתונים, משתמשים יכולים להגדיר את האפשרות "קשירת תהליך עבודה" עבור כפתור. לאחר השלמת הפעולה, תהליך העבודה הקשור יופעל.

ברמת המימוש, מכיוון שטיפול באירועי לאחר פעולה מתבצע בשכבת הביניים (מידלוור של Koa), קריאות API HTTP ל-NocoBase יכולות גם הן להפעיל אירועי לאחר פעולה מוגדרים.

## התקנה

זהו תוסף מובנה, אין צורך בהתקנה.

## הגדרת טריגר

### יצירת תהליך עבודה

בעת יצירת תהליך עבודה, בחרו ב"אירוע לאחר פעולה" כסוג:

![יצירת תהליך עבודה_טריגר אירוע לאחר פעולה](https://static-docs.nocobase.com/13c87035ec1bb7332514676d3e896007.png)

### מצב ביצוע

עבור אירועי לאחר פעולה, ניתן גם לבחור את מצב הביצוע כ"סינכרוני" או "אסינכרוני" בעת יצירתו:

![יצירת תהליך עבודה_בחירת סינכרוני או אסינכרוני](https://static-docs.nocobase.com/bc83525c7e539d578f9e2e20baf9ab69.png)

אם התהליך צריך להתבצע ולהחזיר תוצאה מיד לאחר פעולת המשתמש, ניתן להשתמש במצב סינכרוני; אחרת, ברירת המחדל היא מצב אסינכרוני. במצב אסינכרוני, הפעולה מסתיימת מיד לאחר הפעלת תהליך העבודה, ותהליך העבודה יבוצע ברקע של היישום באופן סדרתי בתור.

### הגדרת אוסף

היכנסו לקנבס תהליך העבודה, לחצו על הטריגר כדי לפתוח את חלון הקונפיגורציה, ובחרו תחילה את האוסף לקשירה:

![הגדרת תהליך עבודה_בחירת אוסף](https://static-docs.nocobase.com/35c49a91eba731127edcf76719c97634.png)

### בחירת מצב הפעלה

לאחר מכן בחרו את מצב ההפעלה, שיכול להיות מקומי או גלובלי:

![הגדרת תהליך עבודה_בחירת מצב הפעלה](https://static-docs.nocobase.com/317809c48b2f2a2d38aedc7d08abdadc.png)

כאשר:

*   מצב מקומי מופעל רק על כפתורי פעולה שאליהם קשור תהליך עבודה זה. לחיצה על כפתורים שאינם קשורים לתהליך עבודה זה לא תפעיל אותו. ניתן להחליט אם לקשור תהליך עבודה זה בהתבסס על השאלה האם טפסים בעלי מטרות שונות צריכים להפעיל את אותו תהליך.
*   מצב גלובלי מופעל על כל כפתורי הפעולה המוגדרים של האוסף, ללא קשר לטופס שממנו הם מגיעים, ואין צורך לקשור את תהליך העבודה המתאים.

במצב מקומי, כפתורי הפעולה התומכים כיום בקשירה הם כדלקמן:

*   כפתורי "שליחה" ו"שמירה" בטופס ההוספה.
*   כפתורי "שליחה" ו"שמירה" בטופס העדכון.
*   כפתור "עדכון נתונים" בשורות נתונים (טבלה, רשימה, קנבן וכו').

### בחירת סוג פעולה

אם בחרתם במצב גלובלי, עליכם לבחור גם את סוג הפעולה. כיום נתמכות "פעולת יצירת נתונים" ו"פעולת עדכון נתונים". שתי הפעולות מפעילות את תהליך העבודה לאחר שהפעולה הושלמה בהצלחה.

### בחירת נתוני קשר טעונים מראש

אם אתם צריכים להשתמש בנתונים הקשורים לנתוני ההפעלה בתהליכים הבאים, תוכלו לבחור את שדות הקשר שיטענו מראש:

![הגדרת תהליך עבודה_טעינת קשר מראש](https://static-docs.nocobase.com/5cded063509c7ba1d34f49bec8d68227.png)

לאחר ההפעלה, תוכלו להשתמש ישירות בנתונים קשורים אלה בתהליך.

## הגדרת פעולה

עבור פעולות במצב הפעלה מקומי, לאחר הגדרת תהליך העבודה, עליכם לחזור לממשק המשתמש ולקשור את תהליך העבודה לכפתור הפעולה של הטופס בבלוק הנתונים המתאים.

תהליכי עבודה שהוגדרו עבור כפתור "שליחה" (כולל כפתור "שמירת נתונים") יופעלו לאחר שהמשתמש ישלח את הטופס המתאים ופעולת הנתונים תושלם.

![אירוע לאחר פעולה_כפתור שליחה](https://static-docs.nocobase.com/ae12d219b8400d75b395880ec4cb2bda.png)

בחרו "קשירת תהליך עבודה" מתפריט הגדרות הכפתור כדי לפתוח את חלון הקונפיגורציה של הקשירה. בחלון הקופץ, תוכלו להגדיר כל מספר של תהליכי עבודה שיופעלו. אם לא מוגדר אף אחד, המשמעות היא שאין צורך בהפעלה. עבור כל תהליך עבודה, עליכם לציין תחילה האם נתוני ההפעלה הם נתוני הטופס כולו או נתוני שדה קשר מסוים בטופס. לאחר מכן, בהתבסס על האוסף המתאים למודל הנתונים שנבחר, בחרו את תהליך העבודה של הטופס שהוגדר להתאים למודל אוסף זה.

![אירוע לאחר פעולה_הגדרת קשירת תהליך עבודה_בחירת הקשר](https://static-docs.nocobase.com/358315fc175849a7fbadbe3276ac6fed.png)

![אירוע לאחר פעולה_הגדרת קשירת תהליך עבודה_בחירת תהליך עבודה](https://static-docs.nocobase.com/175a71a61b93540cce62a1cb124eb0b5.png)

:::info{title="הערה"}
תהליך העבודה חייב להיות מופעל לפני שניתן יהיה לבחור אותו בממשק שלעיל.
:::

## דוגמה

הנה הדגמה באמצעות פעולת יצירה.

נניח תרחיש של "בקשת החזר הוצאות". אנו צריכים לבצע בדיקה אוטומטית של הסכום ובדיקה ידנית עבור סכומים העולים על המגבלה, לאחר שעובד מגיש בקשת החזר. רק בקשות שעוברות את הבדיקה מאושרות ולאחר מכן מועברות למחלקת הכספים לטיפול.

ראשית, נוכל ליצור אוסף "החזר הוצאות" עם השדות הבאים:

- שם פרויקט: טקסט בשורה אחת
- מגיש בקשה: רבים-לאחד (משתמש)
- סכום: מספר
- סטטוס: בחירה יחידה ("אושר", "טופל")

לאחר מכן, צרו תהליך עבודה מסוג "אירוע לאחר פעולה" והגדירו את מודל האוסף בטריגר להיות אוסף "החזר הוצאות":

![דוגמה_הגדרת טריגר_בחירת אוסף](https://static-docs.nocobase.com/6e1abb5c3e1198038676115943714f07.png)

הגדירו את תהליך העבודה למצב מופעל, ונחזור להגדיר את צומתי הטיפול הספציפיים של התהליך מאוחר יותר.

לאחר מכן, ניצור בלוק טבלה עבור אוסף "החזר הוצאות" בממשק, נוסיף כפתור "הוספה" לסרגל הכלים, ונגדיר את שדות הטופס המתאימים. באפשרויות ההגדרה של כפתור הפעולה "שליחה" של הטופס, נפתח את תיבת הדו-שיח "קשירת תהליך עבודה", נבחר את כל נתוני הטופס כהקשר, ונבחר את תהליך העבודה שיצרנו קודם לכן:

![דוגמה_הגדרת כפתור טופס_קשירת תהליך עבודה](https://static-docs.nocobase.com/fc00bdcdb975bb8850e5cab235f854f3.png)

לאחר השלמת הגדרת הטופס, חזרו לתזמור הלוגיקה של תהליך העבודה. לדוגמה, אנו דורשים בדיקה ידנית על ידי מנהל כאשר הסכום גדול מ-500, אחרת הוא מאושר ישירות. לאחר האישור, נוצרת רשומת החזר הוצאות והיא מטופלת בהמשך על ידי מחלקת הכספים (הושמט).

![דוגמה_זרימת טיפול](https://static-docs.nocobase.com/059e8e3d5ffb34cc2da6880fa3dc490b.png)

בהתעלם מהטיפול העוקב של מחלקת הכספים, הגדרת תהליך בקשת החזר ההוצאות הושלמה כעת. כאשר עובד ממלא ושולח בקשת החזר, תהליך העבודה המתאים יופעל. אם סכום ההוצאה נמוך מ-500, רשומה תיווצר אוטומטית ותמתין לטיפול נוסף על ידי הכספים. אחרת, היא תיבדק על ידי מנהל, ולאחר האישור, גם רשומה תיווצר ותועבר לכספים.

התהליך בדוגמה זו יכול להיות מוגדר גם על כפתור "שליחה" רגיל. ניתן להחליט אם ליצור רשומה תחילה לפני ביצוע תהליכים עוקבים, בהתבסס על התרחיש העסקי הספציפי.

## קריאה חיצונית

הפעלת אירועי לאחר פעולה אינה מוגבלת לפעולות ממשק משתמש; ניתן להפעיל אותה גם באמצעות קריאות API HTTP.

:::info{title="הערה"}
בעת הפעלת אירוע לאחר פעולה באמצעות קריאת API HTTP, עליכם לשים לב גם למצב ההפעלה של תהליך העבודה ולהתאמה של הגדרת האוסף, אחרת הקריאה עלולה להיכשל או שתתרחש שגיאה.
:::

עבור תהליכי עבודה הקשורים מקומית לכפתור פעולה, ניתן לקרוא להם כך (באמצעות כפתור היצירה של אוסף ה-`posts` כדוגמה):

```bash
curl -X POST -H 'Authorization: Bearer <your token>' -H 'X-Role: <roleName>' -d \
  '{
    "title": "Hello, world!",
    "content": "This is a test post."
  }'
  "http://localhost:3000/api/posts:create?triggerWorkflows=workflowKey"
```

כאשר פרמטר ה-URL `triggerWorkflows` הוא מפתח תהליך העבודה, עם מספר תהליכי עבודה המופרדים בפסיקים. מפתח זה ניתן להשיג על ידי ריחוף העכבר מעל שם תהליך העבודה בחלק העליון של קנבס תהליך העבודה:

![תהליך עבודה_מפתח_שיטת צפייה](https://static-docs.nocobase.com/20240426135108.png)

לאחר שהקריאה לעיל תצליח, אירוע לאחר פעולה של אוסף ה-`posts` המתאים יופעל.

:::info{title="הערה"}
מכיוון שקריאות חיצוניות צריכות להתבסס גם על זהות משתמש, בעת קריאה באמצעות API HTTP, בדומה לבקשות הנשלחות מהממשק הרגיל, יש לספק פרטי אימות, כולל כותרת הבקשה `Authorization` או פרמטר `token` (הטוקן המתקבל לאחר התחברות), וכותרת הבקשה `X-Role` (שם התפקיד הנוכחי של המשתמש).
:::

אם אתם צריכים להפעיל אירוע עבור נתוני קשר מסוג אחד-לאחד בפעולה זו (אחד-לרבים אינו נתמך עדיין), תוכלו להשתמש ב-`!` בפרמטר כדי לציין את נתוני ההפעלה של שדה הקשר:

```bash
curl -X POST -H 'Authorization: Bearer <your token>' -H 'X-Role: <roleName>' -d \
  '{
    "title": "Hello, world!",
    "content": "This is a test post.",
    "category": {
      "title": "Test category"
    }
  }'
  "http://localhost:3000/api/posts:create?triggerWorkflows=workflowKey!category"
```

לאחר שהקריאה לעיל תצליח, אירוע לאחר פעולה של אוסף ה-`categories` המתאים יופעל.

:::info{title="הערה"}
אם האירוע מוגדר במצב גלובלי, אין צורך להשתמש בפרמטר ה-URL `triggerWorkflows` כדי לציין את תהליך העבודה המתאים. קריאה פשוטה לפעולת האוסף המתאימה תפעיל אותו.
:::

## שאלות נפוצות

### הבדל מאירוע לפני פעולה

*   אירוע לפני פעולה: מופעל לפני ביצוע פעולה (כגון הוספה, עדכון וכו'). לפני ביצוע הפעולה, ניתן לאמת או לעבד את הנתונים המבוקשים בתהליך העבודה. אם תהליך העבודה מופסק (הבקשה נחסמת), הפעולה (הוספה, עדכון וכו') לא תבוצע.
*   אירוע לאחר פעולה: מופעל לאחר שפעולת משתמש הושלמה בהצלחה. בשלב זה, הנתונים נשלחו בהצלחה ונשמרו במסד הנתונים, ותהליכים קשורים יכולים להמשיך ולהיות מטופלים בהתבסס על התוצאה המוצלחת.

כפי שמוצג בתמונה למטה:

![סדר ביצוע פעולות](https://static-docs.nocobase.com/7c901be2282067d785205b70391332b7.png)

### הבדל מאירוע אוסף

אירועי לאחר פעולה ואירועי אוסף דומים בכך ששניהם תהליכים המופעלים לאחר שינויי נתונים. עם זאת, רמות היישום שלהם שונות. אירועי לאחר פעולה הם ברמת ה-API, בעוד שאירועי אוסף מיועדים לשינויי נתונים באוסף.

אירועי אוסף קרובים יותר לשכבה הבסיסית של המערכת. במקרים מסוימים, שינוי נתונים שנגרם על ידי אירוע אחד עשוי להפעיל אירוע אחר, וליצור תגובת שרשרת. במיוחד כאשר נתונים באוספים קשורים מסוימים משתנים גם במהלך פעולת האוסף הנוכחי, ניתן להפעיל גם אירועים הקשורים לאוסף המקושר.

הפעלת אירועי אוסף אינה כוללת מידע הקשור למשתמש. לעומת זאת, אירועי לאחר פעולה קרובים יותר לצד המשתמש והם תוצאה של פעולות משתמש. ההקשר של תהליך העבודה יכלול גם מידע הקשור למשתמש, מה שהופך אותו למתאים לטיפול בתהליכים הקשורים לפעולות משתמש. בתכנון העתידי של NocoBase, ייתכן שיתרחבו אירועי לאחר פעולה נוספים שניתן להשתמש בהם להפעלה, ולכן **מומלץ יותר להשתמש באירועי לאחר פעולה** לטיפול בתהליכים שבהם שינויי נתונים נגרמים על ידי פעולות משתמש.

הבדל נוסף הוא שאירועי לאחר פעולה יכולים להיות קשורים מקומית לכפתורי טופס ספציפיים. אם ישנם מספר טפסים, חלק מהגשות הטפסים יכולות להפעיל את האירוע בעוד שאחרות לא. אירועי אוסף, לעומת זאת, מיועדים לשינויי נתונים באוסף כולו ואינם ניתנים לקשירה מקומית.