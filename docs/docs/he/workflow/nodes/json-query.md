---
pkg: '@nocobase/plugin-workflow-json-query'
---
:::tip
מסמך זה תורגם על ידי בינה מלאכותית. לכל אי דיוק, אנא עיין ב[גרסה האנגלית](/en)
:::


# חישוב JSON

## מבוא

בהתבסס על מנועי חישוב JSON שונים, צומת זה מאפשר לחשב או לשנות את המבנה של נתוני JSON מורכבים שנוצרו על ידי צמתים קודמים, כדי שצמתים עוקבים יוכלו להשתמש בהם. לדוגמה, תוצאות של פעולות SQL וצמתי בקשות HTTP ניתנות להמרה באמצעות צומת זה לערכים ולפורמטים של משתנים נדרשים, לשימוש על ידי צמתים עוקבים.

## יצירת צומת

בממשק הגדרות ה-Workflow, לחצו על כפתור הפלוס ("+") בתהליך עבודה כדי להוסיף צומת "חישוב JSON":

![יצירת צומת](https://static-docs.nocobase.com/7de796517539ad9dfc88b7160f1d0dd7.png)

:::info{title=טיפ}
בדרך כלל, צומת חישוב JSON נוצר מתחת לצמתי נתונים אחרים כדי לנתח אותם.
:::

## הגדרות צומת

### מנוע ניתוח

צומת חישוב JSON תומך בתחבירים שונים באמצעות מנועי ניתוח שונים. אתם יכולים לבחור בהתאם להעדפותיכם ולתכונות הייחודיות של כל מנוע. נכון לעכשיו, נתמכים שלושה מנועי ניתוח:

- [JMESPath](https://jmespath.org/)
- [JSONPath Plus](https://jsonpath-plus.github.io/JSONPath/docs/ts/)
- [JSONata](https://jsonata.org/)

![בחירת מנוע](https://static-docs.nocobase.com/29be3b92a62b7d20312d1673e749f2ec.png)

### מקור נתונים

מקור הנתונים יכול להיות התוצאה של צומת קודם, או אובייקט נתונים בהקשר של תהליך העבודה. בדרך כלל, זהו אובייקט נתונים ללא מבנה מובנה, כמו לדוגמה, התוצאה של צומת SQL או צומת בקשת HTTP.

![מקור נתונים](https://static-docs.nocobase.com/f5a97e20693b3d30b3a994a576aa282d.png)

:::info{title=טיפ}
בדרך כלל, אובייקטי הנתונים של צמתים הקשורים לאוספים מובנים באמצעות פרטי הגדרות האוסף, ובדרך כלל אינם דורשים ניתוח באמצעות צומת חישוב JSON.
:::

### ביטוי ניתוח

ביטוי ניתוח מותאם אישית, המבוסס על דרישות הניתוח ומנוע הניתוח שנבחר.

![ביטוי ניתוח](https://static-docs.nocobase.com/181abd162fd32c09b62f6aa1d1cb3ed4.png)

:::info{title=טיפ}
מנועים שונים מספקים תחבירי ניתוח שונים. לפרטים נוספים, עיינו בתיעוד שבקישורים.
:::

החל מגרסה `v1.0.0-alpha.15`, ביטויים תומכים בשימוש במשתנים. משתנים עוברים ניתוח מקדים לפני שמנוע הניתוח הספציפי מבצע אותם, ומחליפים את המשתנים בערכי מחרוזת ספציפיים בהתאם לכללי תבנית מחרוזת, ומשרשרים אותם עם מחרוזות סטטיות אחרות בביטוי כדי ליצור את הביטוי הסופי. תכונה זו שימושית מאוד כאשר אתם צריכים לבנות ביטויים באופן דינמי, לדוגמה, כאשר תוכן JSON מסוים דורש מפתח דינמי לצורך ניתוח.

### מיפוי מאפיינים

כאשר תוצאת החישוב היא אובייקט (או מערך של אובייקטים), ניתן למפות את המאפיינים הנדרשים למשתני משנה באמצעות מיפוי מאפיינים, לשימוש על ידי צמתים עוקבים.

![מיפוי מאפיינים](https://static-docs.nocobase.com/b876abe4ccf6b4709eb8748f21ef3527.png)

:::info{title=טיפ}
עבור תוצאת אובייקט (או מערך של אובייקטים), אם לא מבוצע מיפוי מאפיינים, האובייקט כולו (או מערך האובייקטים) יישמר כמשתנה יחיד בתוצאת הצומת, ולא ניתן יהיה להשתמש בערכי המאפיינים של האובייקט ישירות כמשתנים.
:::

## דוגמה

נניח שהנתונים שיש לנתח מגיעים מצומת SQL קודם ששימש לשליפת נתונים, ותוצאתו היא קבוצה של נתוני הזמנות:

```json
[
  {
    "id": 1,
    "products": [
      {
        "id": 1,
        "title": "Product 1",
        "price": 100,
        "quantity": 1
      },
      {
        "id": 2,
        "title": "Product 2",
        "price": 120,
        "quantity": 2
      }
    ]
  },
  {
    "id": 2,
    "products": [
      {
        "id": 3,
        "title": "Product 3",
        "price": 130,
        "quantity": 1
      },
      {
        "id": 4,
        "title": "Product 4",
        "price": 140,
        "quantity": 2
      }
    ]
  }
]
```

אם אנחנו צריכים לנתח ולחשב את המחיר הכולל של כל אחת משתי ההזמנות בנתונים, ולארוז אותו יחד עם מזהה ההזמנה המתאים לאובייקט, כדי לעדכן את המחיר הכולל של ההזמנה, ניתן להגדיר זאת באופן הבא:

![דוגמה - הגדרות ניתוח SQL](https://static-docs.nocobase.com/e62322a868b26ff98120bfcd6dcdb3bd.png)

1. בחרו במנוע הניתוח JSONata;
2. בחרו בתוצאה של צומת ה-SQL כמקור הנתונים;
3. השתמשו בביטוי JSONata `$[0].{"id": id, "total": products.(price * quantity)}` לניתוח;
4. בחרו במיפוי מאפיינים, ומפו את `id` ו-`total` למשתני משנה;

תוצאת הניתוח הסופית היא כדלקמן:

```json
[
  {
    "id": 1,
    "total": 340
  },
  {
    "id": 2,
    "total": 410
  }
]
```

לאחר מכן, בצעו לולאה על מערך ההזמנות שהושלם כדי לעדכן את המחיר הכולל של ההזמנות.

![עדכון המחיר הכולל של ההזמנה המתאימה](https://static-docs.nocobase.com/b3329b0efe4471f5eed1f0673bef740e.png)