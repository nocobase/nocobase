---
pkg: "@nocobase/plugin-field-encryption"
---
:::tip
מסמך זה תורגם על ידי בינה מלאכותית. לכל אי דיוק, אנא עיין ב[גרסה האנגלית](/en)
:::


# הצפנה

## מבוא

נתונים עסקיים רגישים, כמו מספרי טלפון של לקוחות, כתובות דוא"ל, מספרי כרטיסים וכדומה, ניתנים להצפנה. לאחר ההצפנה, הם נשמרים במסד הנתונים כטקסט מוצפן (ciphertext).

![20251104192513](https://static-docs.nocobase.com/20251104192513.png)

## הצפנה

:::warning
ה`תוסף` מייצר באופן אוטומטי `מפתח יישום` (application key), הנשמר בתיקייה `/storage/apps/main/encryption-field-keys`.

קובץ `מפתח היישום` נקרא על שם מזהה המפתח (Key ID) וסיומתו היא `.key`. אין לשנות את שם הקובץ באופן שרירותי.

יש לשמור את קובץ `מפתח היישום` בבטחה. אם קובץ `מפתח היישום` אובד, הנתונים המוצפנים לא יוכלו להיות מפוענחים.

אם ה`תוסף` מופעל על ידי יישום משנה (sub-application), מפתח היישום נשמר כברירת מחדל בתיקייה `/storage/apps/${sub-application name}/encryption-field-keys`.
:::

### איך זה עובד

הצפנת מעטפה (Envelope Encryption)

![20251118151339](https://static-docs.nocobase.com/20251118151339.png)

### תהליך יצירת מפתח
1. בפעם הראשונה שנוצר שדה מוצפן, המערכת מייצרת באופן אוטומטי `מפתח יישום` באורך 32 סיביות, והוא נשמר בתיקיית האחסון המוגדרת כברירת מחדל בקידוד Base64.
2. בכל פעם שנוצר שדה מוצפן חדש, נוצר עבורו `מפתח שדה` (field key) אקראי באורך 32 סיביות. לאחר מכן, הוא מוצפן באמצעות `מפתח היישום` ו`וקטור הצפנת שדה` (field encryption vector) אקראי באורך 16 סיביות (אלגוריתם הצפנה `AES`), ונשמר בשדה `options` בטבלת `fields`.

### תהליך הצפנת שדה
1. בכל פעם שכותבים נתונים לשדה מוצפן, המערכת מאחזרת תחילה את `מפתח השדה` המוצפן ואת `וקטור הצפנת השדה` משדה `options` בטבלת `fields`.
2. `מפתח השדה` המוצפן מפוענח באמצעות `מפתח היישום` ו`וקטור הצפנת השדה`. לאחר מכן, הנתונים מוצפנים באמצעות `מפתח השדה` ו`וקטור הצפנת נתונים` (data encryption vector) אקראי באורך 16 סיביות (אלגוריתם הצפנה `AES`).
3. הנתונים נחתמים באמצעות `מפתח השדה` המפוענח (אלגוריתם גיבוב `HMAC-SHA256`) ומומרים למחרוזת בקידוד Base64. (ה`חתימת נתונים` (data signature) שנוצרה תשמש בהמשך לאחזור נתונים).
4. `וקטור אתחול הנתונים` (data initialization vector) באורך 16 סיביות ו`טקסט הצופן` (ciphertext) המוצפן מחוברים בינארית, ומומרים למחרוזת בקידוד Base64.
5. מחרוזת `חתימת הנתונים` המקודדת ב-Base64 ומחרוזת `טקסט הצופן` המחוברת והמקודדת ב-Base64 מחוברות באמצעות מפריד `.` .
6. המחרוזת הסופית המחוברת נשמרת במסד הנתונים.

## משתני סביבה

כדי לציין `מפתח יישום` מותאם אישית, ניתן להשתמש במשתנה הסביבה `ENCRYPTION_FIELD_KEY_PATH`. ה`תוסף` יטען את הקובץ בנתיב זה כ`מפתח היישום`.

**דרישות לקובץ `מפתח היישום`:**
1. סיומת הקובץ חייבת להיות `.key`.
2. שם הקובץ ישמש כמזהה המפתח (Key ID); מומלץ להשתמש ב-UUID כדי להבטיח ייחודיות.
3. תוכן הקובץ חייב להיות נתונים בינאריים באורך 32 בתים המקודדים ב-Base64.

```bash
ENCRYPTION_FIELD_KEY_PATH=/path/to/my/app-keys/270263524860909922913.key
```

## הגדרות שדה

![20240802173721](https://static-docs.nocobase.com/20240802173721.png)

## השפעת ההצפנה על סינון נתונים

שדות מוצפנים תומכים רק בסינון לפי: שווה ל-, לא שווה ל-, קיים, לא קיים.

![20240802174042](https://static-docs.nocobase.com/20240802174042.png)

תהליך סינון נתונים:
1. אחזר את `מפתח השדה` המוצפן, ופענח אותו באמצעות `מפתח היישום`.
2. השתמש ב`מפתח השדה` כדי לחתום על טקסט החיפוש שהוזן על ידי המשתמש (HMAC-SHA256).
3. חבר את החתימה עם מפריד `.` ובצע שאילתת התאמת קידומת (prefix-match) על השדה המוצפן במסד הנתונים.

## חילוף מפתחות

:::warning
לפני השימוש בפקודה `nocobase key-rotation` לחילוף מפתחות, ודא שה`תוסף` נטען ביישום.
:::

כאשר יישום מועבר לסביבה חדשה ואינך מעוניין להמשיך להשתמש באותו `מפתח יישום` מהסביבה הישנה, באפשרותך להשתמש בפקודה `nocobase key-rotation` כדי להחליף את `מפתח היישום`.

הפעלת פקודת חילוף המפתחות דורשת ציון של `מפתח היישום` של הסביבה הישנה. לאחר ההפעלה, ייווצר `מפתח יישום` חדש, והוא יחליף את המפתח הישן. `מפתח היישום` החדש יישמר בתיקיית ברירת המחדל בקידוד Base64.

```bash
# --key-path מציין את קובץ מפתח היישום של הסביבה הישנה, התואם לנתונים המוצפנים במסד הנתונים.
 yarn nocobase key-rotation --key-path /path/to/old-app-keys/270263524860909922913.key
```

כדי להחליף את `מפתח היישום` של יישום משנה, יש להוסיף את הפרמטר `--app-name` ולציין את ה`name` של יישום המשנה.

```bash
 yarn nocobase key-rotation --app-name a_w0r211vv0az --key-path /path/to/old-app-keys/270263524860909922913.key
```