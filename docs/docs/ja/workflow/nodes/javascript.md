---
pkg: '@nocobase/plugin-workflow-javascript'
---
:::tip
このドキュメントはAIによって翻訳されました。不正確な情報については、[英語版](/en)をご参照ください
:::


# JavaScript スクリプト

## はじめに

JavaScript スクリプトノードは、ユーザーが**ワークフロー**内でカスタムのサーバーサイドJavaScriptスクリプトを実行できるようにします。スクリプトでは、**ワークフロー**の上流にある変数をパラメーターとして使用でき、その戻り値は下流のノードで利用できます。

スクリプトはNocoBaseアプリケーションのサーバーサイドでワーカースレッドとして実行され、Node.jsのほとんどの機能をサポートしていますが、ネイティブな実行環境とはいくつかの違いがあります。詳細は[機能リスト](#特性リスト)をご覧ください。

## ノードの作成

**ワークフロー**設定画面で、フロー内のプラス（「+」）ボタンをクリックし、「JavaScript」ノードを追加します。

![20241202203457](https://static-docs.nocobase.com/20241202203457.png)

## ノードの設定

![20241202203655](https://static-docs.nocobase.com/20241202203655.png)

### パラメーター

スクリプト内のコードロジックで使用するため、**ワークフロー**のコンテキスト変数や静的な値をスクリプトに渡す際に使用します。`name` はパラメーター名で、スクリプトに渡されると変数名として扱われます。`value` はパラメーター値で、変数を選択するか定数を入力できます。

### スクリプトの内容

スクリプトの内容は関数と見なすことができ、Node.js環境でサポートされている任意のJavaScriptコードを記述できます。`return`文を使用して、ノードの実行結果として値を返し、後続のノードで変数として使用することも可能です。

コードを記述した後、エディターの下にあるテストボタンをクリックすると、テスト実行ダイアログが開きます。ここで静的な値をパラメーターとして入力し、シミュレーション実行を行えます。実行後、ダイアログで戻り値と出力（ログ）の内容を確認できます。

![20241202203833](https://static-docs.nocobase.com/20241202203833.png)

### タイムアウト設定

単位はミリ秒です。`0` に設定すると、タイムアウトは設定されません。

### エラー発生後もフローを続行

チェックを入れると、スクリプトがエラーになったり、タイムアウトエラーが発生したりした場合でも、後続のノードが実行されます。

:::info{title="ヒント"}
スクリプトでエラーが発生した場合、戻り値はありません。ノードの結果にはエラーメッセージが格納されます。後続のノードでスクリプトノードの結果変数が使用される場合は、慎重に処理する必要があります。
:::

## 機能リスト

### Node.js バージョン

メインアプリケーションが実行しているNode.jsのバージョンと同じです。

### モジュールのサポート

スクリプトでは、CommonJSと同様に、`require()`ディレクティブを使用してモジュールをインポートし、制限付きでモジュールを使用できます。

Node.jsのネイティブモジュール、および`node_modules`にインストールされているモジュール（NocoBaseがすでに使用している依存パッケージを含む）をサポートしています。コードで使用可能にするモジュールは、アプリケーションの環境変数`WORKFLOW_SCRIPT_MODULES`で宣言する必要があります。複数のパッケージ名は半角カンマで区切ります。例：

```ini
WORKFLOW_SCRIPT_MODULES=crypto,timers,lodash,dayjs
```

:::info{title="ヒント"}
環境変数`WORKFLOW_SCRIPT_MODULES`で宣言されていないモジュールは、Node.jsネイティブのものであっても、`node_modules`にインストール済みであっても、スクリプト内で**使用できません**。このポリシーは、運用レベルでユーザーが使用できるモジュールリストを管理するために利用でき、特定のシナリオでスクリプトの権限が過剰になるのを防ぎます。
:::

ソースコード以外の環境でデプロイされている場合、`node_modules`に特定のモジュールがインストールされていないときは、必要なパッケージを`storage`ディレクトリに手動でインストールできます。例えば、`exceljs`パッケージを使用する必要がある場合は、以下の操作を実行します。

```shell
cd storage
npm i --no-save --no-package-lock --prefix . exceljs
```

その後、アプリケーションのCWD（現在の作業ディレクトリ）を基準とした相対パス（または絶対パス）で、そのパッケージを環境変数`WORKFLOW_SCRIPT_MODULES`に追加します。

```ini
WORKFLOW_SCRIPT_MODULES=./storage/node_modules/exceljs
```

これで、スクリプト内で`exceljs`パッケージを使用できます。

```js
const ExcelJS = require('exceljs');
// ...
```

### グローバル変数

`global`、`process`、`__dirname`、`__filename`などのグローバル変数は**サポートしていません**。

```js
console.log(global); // will throw error: "global is not defined"
```

### 渡されるパラメーター

ノードで設定されたパラメーターは、スクリプト内でグローバル変数として直接使用できます。スクリプトに渡されるパラメーターは、`boolean`、`number`、`string`、`object`、配列などの基本型のみをサポートしています。`Date`オブジェクトが渡されると、ISO形式の文字列に変換されます。カスタムクラスのインスタンスなど、その他の複雑な型は直接渡すことはできません。

### 戻り値

`return`文を使用すると、基本型のデータ（パラメーターと同じルール）をノードの結果として返すことができます。コード内で`return`文が呼び出されない場合、ノードの実行は戻り値を持ちません。

```js
return 123;
```

### 出力（ログ）

`console`を使用したログ出力を**サポートしています**。

```js
console.log('hello world!');
```

**ワークフロー**の実行時、スクリプトノードの出力も対応する**ワークフロー**のログファイルに記録されます。

### 非同期

`async`を使用した非同期関数の定義、および`await`を使用した非同期関数の呼び出しを**サポートしています**。`Promise`グローバルオブジェクトの使用を**サポートしています**。

```js
async function test() {
  return Promise.resolve(1);
}

const value = await test();
return value;
```

### タイマー

`setTimeout`、`setInterval`、`setImmediate`などのメソッドを使用する場合は、Node.jsの`timers`パッケージを介してインポートする必要があります。

```js
const { setTimeout, setInterval, setImmediate, clearTimeout, clearInterval, clearImmediate } = require('timers');

async function sleep(time) {
  return new Promise((resolve) => setTimeout(resolve, time));
}

await sleep(1000);

return 123;
```