# 页面筛选器与联动

页面筛选器（Filter Block）用于在页面级统一输入筛选条件，并将其合并到图表查询中，实现多图一致的筛选与联动。

![截图占位：页面筛选器与图表联动示意](https://static-docs.nocobase.com/20251023232724.png)

## 功能概览
- 在页面上添加“筛选器块”，为当前页面的图表提供统一的筛选入口。
- 通过“筛选”“重置”“折叠”按钮进行应用、清空与收起操作。
- 自动将筛选器的值合并到图表的查询请求中，触发图表刷新。

## 合并与生效规则
图表请求合并由系统自动完成，核心规则如下：

- 基本合并（同数据源 & 同集合）
  - 当图表与筛选器的“数据源 + 集合”一致时，页面筛选器会将值合并到图表查询的 `filter` 中，形成：
    - `{$and: [图表原有条件, 页面筛选条件]}`，并自动清理不可解析项。
  - 适用于 Builder 模式的图表（查询体包含 `measures`）。

- 自定义参数合并（跨集合/复杂场景）
  - 在图表的查询过滤中显式引用 `$nFilter.<name>`，即可将筛选器“自定义项”的值注入图表查询：
    - 例如：图表过滤写入 `status: {{$nFilter.status}}`。
  - 系统会解析图表查询中的该引用并与页面筛选值深度合并，再以 `$and` 与页面基础筛选拼接。

- 触发与刷新
  - 点击筛选器的“筛选”按钮，会对当前页面所有符合上述规则的图表执行刷新。
  - 过滤块启用后，图表会等待筛选器表单渲染完毕再执行查询，确保筛选值生效。

![截图占位：筛选、重置、折叠操作区](https://static-docs.nocobase.com/20251023232724.png)

## 配置筛选器
- 在页面设计模式下添加“筛选器块”，并添加筛选项：
  - 选择字段与运算符（=、≠、包含、介于等），右侧支持“变量选择器”和“表达式”。
  - 关联字段（如 `m2o`）会自动使用目标键（如 `id`）进行筛选。
- 可添加“自定义项”（命名为 `name`），供图表在查询中通过 `$nFilter.<name>` 引用，实现跨集合联动。

示例：常见筛选项
- `status = <选中项>`（Select）
- `createdAt 介于 $nDate.last30Days`（Date Range）
- “自定义项”命名为 `region`，图表查询写 `region: {{$nFilter.region}}`。

![截图占位：添加筛选项与配置数据源/集合](https://static-docs.nocobase.com/20251023232724.png)

## 在图表查询中使用页面筛选值
- Builder 模式（推荐）
  - 直接依赖自动合并：同数据源&集合时，无需在图表查询中额外写变量，页面筛选会以 `$and` 合并。
  - 高级定制：在图表过滤中写入 `$nFilter.<name>`，用于跨集合或复杂结构的条件。

- SQL 模式（通过变量注入）
  - 在 SQL 语句中使用 `{{ $nFilter.<name> }}` 引用页面筛选器“自定义项”的值。
  - 示例：
    ```sql
    SELECT *
    FROM orders
    WHERE status = {{ $nFilter.status }}
      AND created_at BETWEEN {{ $nDate.last30Days.0 }} AND {{ $nDate.last30Days.1 }};
    ```

注意：
- 页面筛选器的“自动合并”主要作用于 Builder 模式（包含 `measures` 的图表请求）。
- SQL 模式图表不参与上述自动 `$and` 合并；请通过 `$nFilter.<name>` 在 SQL 中显式注入筛选值。

## 操作与联动
- 筛选（Filter）：应用当前筛选值到页面图表（符合规则的图表）。
- 重置（Reset）：清空当前筛选值并刷新图表。
- 折叠（Collapse/Expand）：收起或展开筛选器区域，不影响筛选逻辑。

多图联动：
- 页面中多张图表共享“数据源 & 集合”时，将同步应用筛选器值。
- 更复杂的跨图联动与行为（如点击图后改写筛选器值、打开详情）可在“自定义交互事件”中实现，参考“交互事件”文档。

## 调试与常见问题
- 图表没有更新：
  - 检查筛选器块是否启用且已渲染。
  - 确认图表配置了 `measures`（Builder 模式），或在 SQL 中显式使用 `$nFilter.<name>`。
  - 确认图表与筛选器的“数据源 & 集合”一致。
- 条件无效或报错：
  - 先在“数据查询 → 查看数据”中确认列名与类型。
  - 过滤条件中若引用变量，请确保变量存在且类型匹配；不可解析项会被自动清理。

## 最佳实践
- 尽量使用页面级筛选器实现通用条件，避免在每个图表重复配置。
- 日期范围统一使用 `$nDate`，并选择合适的本地/UTC 精确值（`$nExactDate`）以避免时区问题。
- 跨集合/复杂联动场景下，优先通过 `$nFilter.<name>` 实现图表查询参数注入，再配合事件实现更丰富的交互。