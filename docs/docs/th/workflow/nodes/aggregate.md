---
pkg: '@nocobase/plugin-workflow-aggregate'
---
:::tip
เอกสารนี้แปลโดย AI หากมีข้อมูลที่ไม่ถูกต้อง โปรดดู[เวอร์ชันภาษาอังกฤษ](/en)
:::

# การสอบถามแบบรวมกลุ่ม (Aggregate Query)

## บทนำ

โหนดนี้ใช้สำหรับเรียกดูข้อมูลแบบรวมกลุ่ม (aggregate function) จากคอลเลกชันที่ตรงตามเงื่อนไขที่กำหนด และส่งคืนผลลัพธ์ทางสถิติที่เกี่ยวข้อง มักใช้ในการประมวลผลข้อมูลสถิติสำหรับรายงานต่างๆ ครับ/ค่ะ

การทำงานของโหนดนี้อิงตามฟังก์ชันรวมกลุ่มของฐานข้อมูล ปัจจุบันรองรับการรวบรวมสถิติจากฟิลด์เดียวในคอลเลกชันเดียวเท่านั้น ผลลัพธ์ที่เป็นตัวเลขจะถูกบันทึกไว้ในผลลัพธ์ของโหนด เพื่อให้โหนดอื่นๆ สามารถนำไปใช้ต่อได้ครับ/ค่ะ

## การติดตั้ง

เป็นปลั๊กอินที่มาพร้อมกับระบบ ไม่ต้องติดตั้งเพิ่มเติมครับ/ค่ะ

## การสร้างโหนด

ในหน้าจอการตั้งค่าเวิร์กโฟลว์ ให้คลิกปุ่มเครื่องหมายบวก (“+”) ในโฟลว์ เพื่อเพิ่มโหนด "การสอบถามแบบรวมกลุ่ม" ครับ/ค่ะ

![สร้างโหนดการสอบถามแบบรวมกลุ่ม](https://static-docs.nocobase.com/7f9d806ebf5064f80c30f8b67f316f0f.png)

## การตั้งค่าโหนด

![การตั้งค่าโหนดการสอบถามแบบรวมกลุ่ม](https://static-docs.nocobase.com/57362f747b9992230567c6bb5e986fd2.png)

### ฟังก์ชันรวมกลุ่ม (Aggregate Function)

รองรับฟังก์ชันรวมกลุ่ม 5 แบบจาก SQL ได้แก่ `COUNT`, `SUM`, `AVG`, `MIN` และ `MAX` เลือกหนึ่งในฟังก์ชันเหล่านี้เพื่อทำการสอบถามแบบรวมกลุ่มกับข้อมูลครับ/ค่ะ

### ประเภทเป้าหมาย (Target Type)

คุณสามารถเลือกเป้าหมายของการสอบถามแบบรวมกลุ่มได้สองโหมดครับ/ค่ะ โหมดแรกคือการเลือกคอลเลกชันเป้าหมายและฟิลด์ที่ต้องการโดยตรง อีกโหมดหนึ่งคือการเลือกคอลเลกชันและฟิลด์ที่มีความสัมพันธ์แบบหนึ่งต่อหลาย (one-to-many) จากออบเจกต์ข้อมูลที่มีอยู่ในบริบทของเวิร์กโฟลว์ เพื่อทำการสอบถามแบบรวมกลุ่มครับ/ค่ะ

### การลบข้อมูลซ้ำ (Distinct)

คือ `DISTINCT` ใน SQL ครับ/ค่ะ ฟิลด์ที่ใช้ในการลบข้อมูลซ้ำจะเหมือนกับฟิลด์ของคอลเลกชันที่เลือกไว้ ปัจจุบันยังไม่รองรับการเลือกฟิลด์ที่แตกต่างกันสำหรับสองส่วนนี้ครับ/ค่ะ

### เงื่อนไขการกรอง (Filter Conditions)

คล้ายกับเงื่อนไขการกรองในการสอบถามคอลเลกชันทั่วไป คุณสามารถใช้ตัวแปรบริบทจากเวิร์กโฟลว์ได้ครับ/ค่ะ

## ตัวอย่าง

การรวมกลุ่มเป้าหมาย "ข้อมูลคอลเลกชัน" ค่อนข้างเข้าใจง่ายครับ/ค่ะ ในที่นี้ เราจะยกตัวอย่าง "การนับจำนวนบทความทั้งหมดในหมวดหมู่หลังจากมีการเพิ่มบทความใหม่" เพื่ออธิบายการใช้งานการรวมกลุ่มเป้าหมาย "ข้อมูลคอลเลกชันที่เชื่อมโยง" ครับ/ค่ะ

อันดับแรก สร้างคอลเลกชันสองคอลเลกชัน ได้แก่ "บทความ" และ "หมวดหมู่" โดยคอลเลกชันบทความจะมีฟิลด์ความสัมพันธ์แบบหลายต่อหนึ่ง (many-to-one) ที่ชี้ไปยังคอลเลกชันหมวดหมู่ และสร้างฟิลด์ความสัมพันธ์ย้อนกลับแบบหนึ่งต่อหลาย (one-to-many) จากหมวดหมู่ไปยังบทความด้วยครับ/ค่ะ

| ชื่อฟิลด์   | ประเภท           |
| -------- | -------------- |
| หัวข้อ     | ข้อความบรรทัดเดียว       |
| หมวดหมู่ | หลายต่อหนึ่ง (หมวดหมู่) |

| ชื่อฟิลด์   | ประเภท           |
| -------- | -------------- |
| ชื่อหมวดหมู่ | ข้อความบรรทัดเดียว       |
| บทความ | หนึ่งต่อหลาย (บทความ) |

จากนั้น สร้างเวิร์กโฟลว์ที่ถูกทริกเกอร์ด้วยเหตุการณ์คอลเลกชัน โดยเลือกให้ทริกเกอร์หลังจากมีการเพิ่มข้อมูลใหม่ในคอลเลกชันบทความครับ/ค่ะ

หลังจากนั้น ให้เพิ่มโหนด "การสอบถามแบบรวมกลุ่ม" และตั้งค่าดังนี้ครับ/ค่ะ

![การตั้งค่าโหนดการสอบถามแบบรวมกลุ่ม_ตัวอย่าง](https://static-docs.nocobase.com/542272e638c6c0a567373d1b37ddda78.png)

ด้วยวิธีนี้ หลังจากเวิร์กโฟลว์ถูกทริกเกอร์ โหนด "การสอบถามแบบรวมกลุ่ม" จะนับจำนวนบทความทั้งหมดในหมวดหมู่ของบทความที่เพิ่มเข้ามาใหม่ และบันทึกเป็นผลลัพธ์ของโหนดครับ/ค่ะ

:::info{title=เคล็ดลับ}
หากคุณต้องการใช้ข้อมูลความสัมพันธ์จากตัวทริกเกอร์เหตุการณ์คอลเลกชัน คุณต้องตั้งค่าฟิลด์ที่เกี่ยวข้องในส่วน "โหลดข้อมูลที่เชื่อมโยงล่วงหน้า" (Preload associated data) ของตัวทริกเกอร์ มิฉะนั้นจะไม่สามารถเลือกได้ครับ/ค่ะ
:::