---
pkg: '@nocobase/plugin-workflow-json-query'
---
:::tip
เอกสารนี้แปลโดย AI หากมีข้อมูลที่ไม่ถูกต้อง โปรดดู[เวอร์ชันภาษาอังกฤษ](/en)
:::

# การคำนวณ JSON

## บทนำ

โหนดนี้ใช้เอนจินการคำนวณ JSON ที่หลากหลาย เพื่อคำนวณหรือแปลงโครงสร้างข้อมูล JSON ที่ซับซ้อนซึ่งมาจากโหนดต้นทาง ให้พร้อมสำหรับโหนดถัดไปนำไปใช้ได้ครับ/ค่ะ ตัวอย่างเช่น ผลลัพธ์จากโหนดการดำเนินการ SQL และโหนดคำขอ HTTP สามารถถูกแปลงให้เป็นค่าและรูปแบบตัวแปรที่ต้องการผ่านโหนดนี้ เพื่อให้โหนดถัดไปนำไปใช้งานต่อได้ครับ/ค่ะ

## การสร้างโหนด

ในหน้าจอการตั้งค่าเวิร์กโฟลว์ ให้คลิกปุ่มเครื่องหมายบวก ("+") ในโฟลว์ เพื่อเพิ่มโหนด "JSON Calculation" ครับ/ค่ะ

![สร้างโหนด](https://static-docs.nocobase.com/7de796517539ad9dfc88b7160f1d0dd7.png)

:::info{title=ข้อแนะนำ}
โดยทั่วไปแล้ว โหนด JSON Calculation มักจะถูกสร้างไว้ใต้โหนดข้อมูลอื่น ๆ เพื่อใช้ในการแยกวิเคราะห์ข้อมูลเหล่านั้นครับ/ค่ะ
:::

## การตั้งค่าโหนด

### เอนจินการแยกวิเคราะห์

โหนด JSON Calculation รองรับไวยากรณ์ที่แตกต่างกันผ่านเอนจินการแยกวิเคราะห์ที่หลากหลายครับ/ค่ะ คุณสามารถเลือกได้ตามความต้องการและคุณสมบัติเฉพาะของแต่ละเอนจิน ปัจจุบันรองรับเอนจินการแยกวิเคราะห์สามประเภท ได้แก่:

- [JMESPath](https://jmespath.org/)
- [JSONPath Plus](https://jsonpath-plus.github.io/JSONPath/docs/ts/)
- [JSONata](https://jsonata.org/)

![การเลือกเอนจิน](https://static-docs.nocobase.com/29be3b92a62b7d20312d1673e749f2ec.png)

### แหล่งข้อมูล

แหล่งข้อมูลสามารถเป็นผลลัพธ์จากโหนดต้นทาง หรือเป็นออบเจกต์ข้อมูลในบริบทของเวิร์กโฟลว์ก็ได้ครับ/ค่ะ โดยทั่วไปแล้วจะเป็นออบเจกต์ข้อมูลที่ไม่มีโครงสร้างภายในตัว เช่น ผลลัพธ์จากโหนด SQL หรือโหนดคำขอ HTTP

![แหล่งข้อมูล](https://static-docs.nocobase.com/f5a97e20693b3d30b3a994a576aa282d.png)

:::info{title=ข้อแนะนำ}
โดยทั่วไปแล้ว ออบเจกต์ข้อมูลของโหนดที่เกี่ยวข้องกับคอลเลกชันจะถูกจัดโครงสร้างผ่านข้อมูลการตั้งค่าคอลเลกชันอยู่แล้วครับ/ค่ะ จึงไม่จำเป็นต้องแยกวิเคราะห์ด้วยโหนด JSON Calculation
:::

### นิพจน์การแยกวิเคราะห์

คุณสามารถกำหนดนิพจน์การแยกวิเคราะห์เองได้ โดยขึ้นอยู่กับความต้องการในการแยกวิเคราะห์และเอนจินการแยกวิเคราะห์ที่คุณเลือกครับ/ค่ะ

![นิพจน์การแยกวิเคราะห์](https://static-docs.nocobase.com/181abd162fd32c09b62f6aa1d1cb3ed4.png)

:::info{title=ข้อแนะนำ}
เอนจินแต่ละตัวมีไวยากรณ์การแยกวิเคราะห์ที่แตกต่างกันครับ/ค่ะ สำหรับรายละเอียดเพิ่มเติม โปรดดูเอกสารประกอบในลิงก์ที่ให้ไว้
:::

ตั้งแต่เวอร์ชัน `v1.0.0-alpha.15` เป็นต้นไป นิพจน์รองรับการใช้งานตัวแปรครับ/ค่ะ ตัวแปรจะถูกแยกวิเคราะห์ล่วงหน้าก่อนที่เอนจินจะทำงาน โดยจะแทนที่ตัวแปรด้วยค่าสตริงที่เฉพาะเจาะจงตามกฎของเทมเพลตสตริง และนำไปเชื่อมต่อกับสตริงคงที่อื่น ๆ ในนิพจน์เพื่อสร้างนิพจน์สุดท้าย คุณสมบัตินี้มีประโยชน์มากเมื่อคุณต้องการสร้างนิพจน์แบบไดนามิก เช่น เมื่อเนื้อหา JSON บางส่วนต้องการคีย์แบบไดนามิกสำหรับการแยกวิเคราะห์

### การแมปคุณสมบัติ

เมื่อผลลัพธ์ของการคำนวณเป็นออบเจกต์ (หรืออาร์เรย์ของออบเจกต์) คุณสามารถแมปคุณสมบัติที่ต้องการให้เป็นตัวแปรย่อยเพิ่มเติมผ่านการแมปคุณสมบัติ เพื่อให้โหนดถัดไปนำไปใช้งานได้ครับ/ค่ะ

![การแมปคุณสมบัติ](https://static-docs.nocobase.com/b876abe4ccf6b4709eb8748f21ef3527.png)

:::info{title=ข้อแนะนำ}
สำหรับผลลัพธ์ที่เป็นออบเจกต์ (หรืออาร์เรย์ของออบเจกต์) หากไม่มีการแมปคุณสมบัติ ออบเจกต์ทั้งหมด (หรืออาร์เรย์ของออบเจกต์) จะถูกบันทึกเป็นตัวแปรเดียวในผลลัพธ์ของโหนดครับ/ค่ะ ซึ่งจะทำให้ไม่สามารถใช้ค่าคุณสมบัติของออบเจกต์โดยตรงในรูปแบบของตัวแปรได้
:::

## ตัวอย่าง

สมมติว่าข้อมูลที่ต้องการแยกวิเคราะห์มาจากโหนด SQL ก่อนหน้า ซึ่งใช้สำหรับสอบถามข้อมูล และผลลัพธ์ที่ได้คือชุดข้อมูลคำสั่งซื้อดังนี้ครับ/ค่ะ

```json
[
  {
    "id": 1,
    "products": [
      {
        "id": 1,
        "title": "Product 1",
        "price": 100,
        "quantity": 1
      },
      {
        "id": 2,
        "title": "Product 2",
        "price": 120,
        "quantity": 2
      }
    ]
  },
  {
    "id": 2,
    "products": [
      {
        "id": 3,
        "title": "Product 3",
        "price": 130,
        "quantity": 1
      },
      {
        "id": 4,
        "title": "Product 4",
        "price": 140,
        "quantity": 2
      }
    ]
  }
]
```

หากเราต้องการแยกวิเคราะห์และคำนวณราคารวมของคำสั่งซื้อสองรายการในข้อมูล และนำมารวมกับ ID คำสั่งซื้อที่เกี่ยวข้องให้อยู่ในรูปแบบออบเจกต์ เพื่อใช้อัปเดตราคารวมของคำสั่งซื้อ เราสามารถตั้งค่าได้ดังนี้ครับ/ค่ะ

![ตัวอย่าง - การตั้งค่าการแยกวิเคราะห์ SQL](https://static-docs.nocobase.com/e62322a868b26ff98120bfcd6dcdb3bd.png)

1.  เลือกเอนจินการแยกวิเคราะห์ JSONata
2.  เลือกผลลัพธ์จากโหนด SQL เป็นแหล่งข้อมูล
3.  ใช้ JSONata expression `$[0].{"id": id, "total": products.(price * quantity)}` ในการแยกวิเคราะห์
4.  เลือกการแมปคุณสมบัติ เพื่อแมป `id` และ `total` ให้เป็นตัวแปรย่อย

ผลลัพธ์การแยกวิเคราะห์สุดท้ายจะเป็นดังนี้ครับ/ค่ะ

```json
[
  {
    "id": 1,
    "total": 340
  },
  {
    "id": 2,
    "total": 410
  }
]
```

จากนั้น ให้วนลูปผ่านอาร์เรย์ของคำสั่งซื้อที่ได้ เพื่ออัปเดตราคารวมของคำสั่งซื้อได้เลยครับ/ค่ะ

![อัปเดตราคารวมของคำสั่งซื้อที่เกี่ยวข้อง](https://static-docs.nocobase.com/b3329b0efe4471f5eed1f0673bef740e.png)