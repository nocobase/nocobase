:::tip Уведомление о переводе ИИ
Эта документация была автоматически переведена ИИ.
:::

# AuthManager

## Обзор

`AuthManager` — это модуль управления аутентификацией пользователей в NocoBase, предназначенный для регистрации различных типов аутентификации.

### Базовое использование

```ts
const authManager = new AuthManager({
  // Используется для получения идентификатора текущего аутентификатора из заголовка запроса
  authKey: 'X-Authenticator',
});

// Устанавливает методы для хранения и получения аутентификаторов в AuthManager
authManager.setStorer({
  get: async (name: string) => {
    return db.getRepository('authenticators').find({ filter: { name } });
  },
});

// Регистрирует тип аутентификации
authManager.registerTypes('basic', {
  auth: BasicAuth,
  title: 'Password',
});

// Использует промежуточное ПО для аутентификации
app.resourceManager.use(authManager.middleware());
```

### Концепции

- **Тип аутентификации (`AuthType`)**: Различные методы аутентификации пользователей, например: пароль, SMS, OIDC, SAML и т.д.
- **Аутентификатор (`Authenticator`)**: Сущность метода аутентификации, которая фактически хранится в **коллекции** и соответствует записи конфигурации определённого типа аутентификации (`AuthType`). Один метод аутентификации может иметь несколько аутентификаторов, соответствующих различным конфигурациям, предоставляя разные способы аутентификации пользователей.
- **Идентификатор аутентификатора (`Authenticator name`)**: Уникальный идентификатор аутентификатора, используемый для определения метода аутентификации для текущего запроса.

## Методы класса

### `constructor()`

Конструктор, создаёт экземпляр `AuthManager`.

#### Подпись

- `constructor(options: AuthManagerOptions)`

#### Типы

```ts
export interface JwtOptions {
  secret: string;
  expiresIn?: string;
}

export type AuthManagerOptions = {
  authKey: string;
  default?: string;
  jwt?: JwtOptions;
};
```

#### Подробности

##### AuthManagerOptions

| Свойство  | Тип                         | Описание                                                | По умолчанию      |
| --------- | --------------------------- | ------------------------------------------------------- | ----------------- |
| `authKey` | `string`                    | Необязательно, ключ в заголовке запроса, содержащий идентификатор текущего аутентификатора. | `X-Authenticator` |
| `default` | `string`                    | Необязательно, идентификатор аутентификатора по умолчанию. | `basic`           |
| `jwt`     | [`JwtOptions`](#jwtoptions) | Необязательно, можно настроить, если используется JWT для аутентификации. | -                 |

##### JwtOptions

| Свойство    | Тип      | Описание                 | По умолчанию      |
| ----------- | -------- | ------------------------ | ----------------- |
| `secret`    | `string` | Секрет токена            | `X-Authenticator` |
| `expiresIn` | `string` | Необязательно, время жизни токена. | `7d`              |

### `setStorer()`

Устанавливает методы для хранения и получения данных аутентификатора.

#### Подпись

- `setStorer(storer: Storer)`

#### Типы

```ts
export interface Authenticator = {
  authType: string;
  options: Record<string, any>;
  [key: string]: any;
};

export interface Storer {
  get: (name: string) => Promise<Authenticator>;
}
```

#### Подробности

##### Authenticator

| Свойство   | Тип                   | Описание                          |
| ---------- | --------------------- | --------------------------------- |
| `authType` | `string`              | Тип аутентификации                |
| `options`  | `Record<string, any>` | Конфигурация, связанная с аутентификатором |

##### Storer

`Storer` — это интерфейс для хранения аутентификаторов, содержащий один метод.

- `get(name: string): Promise<Authenticator>` — Получает аутентификатор по его идентификатору. В NocoBase фактический возвращаемый тип — [AuthModel](/auth-verification/auth/dev/api#authmodel).

### `registerTypes()`

Регистрирует тип аутентификации.

#### Подпись

- `registerTypes(authType: string, authConfig: AuthConfig)`

#### Типы

```ts
export type AuthExtend<T extends Auth> = new (config: Config) => T;

type AuthConfig = {
  auth: AuthExtend<Auth>; // Класс аутентификации.
  title?: string; // Отображаемое имя типа аутентификации.
};
```

#### Подробности

| Свойство | Тип                | Описание                                                |
| ------- | ------------------ | ------------------------------------------------------- |
| `auth`  | `AuthExtend<Auth>` | Реализация типа аутентификации, см. [Auth](./auth)      |
| `title` | `string`           | Необязательно. Заголовок этого типа аутентификации, отображаемый во фронтенде. |

### `listTypes()`

Получает список зарегистрированных типов аутентификации.

#### Подпись

- `listTypes(): { name: string; title: string }[]`

#### Подробности

| Свойство | Тип      | Описание                     |
| ------- | -------- | ---------------------------- |
| `name`  | `string` | Идентификатор типа аутентификации |
| `title` | `string` | Заголовок типа аутентификации |

### `get()`

Получает аутентификатор.

#### Подпись

- `get(name: string, ctx: Context)`

#### Подробности

| Свойство | Тип       | Описание              |
| ------ | --------- | --------------------- |
| `name` | `string`  | Идентификатор аутентификатора |
| `ctx`  | `Context` | Контекст запроса      |

### `middleware()`

Промежуточное ПО для аутентификации. Получает текущий аутентификатор и выполняет аутентификацию пользователя.