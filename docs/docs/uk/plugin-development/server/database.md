:::tip Повідомлення про переклад ШІ
Ця документація була автоматично перекладена штучним інтелектом.
:::


# База даних

Об'єкт `Database` є важливою складовою джерел даних типу "база даних" (`DataSource`). Кожне джерело даних такого типу має відповідний екземпляр `Database`, доступ до якого можна отримати через `dataSource.db`. Екземпляр бази даних основного джерела даних також надає зручний псевдонім `app.db`. Ознайомлення зі стандартними методами `db` є основою для написання серверних плагінів.

## Складові частини `Database`

Типовий об'єкт `Database` складається з таких частин:

- **Колекція** (`Collection`): Визначає структуру таблиці даних.
- **Модель** (`Model`): Відповідає моделям ORM (зазвичай керується Sequelize).
- **Репозиторій** (`Repository`): Рівень репозиторію, який інкапсулює логіку доступу до даних, надаючи методи для операцій вищого рівня.
- **Тип поля** (`FieldType`): Типи полів.
- **Оператор фільтрації** (`FilterOperator`): Оператори, що використовуються для фільтрації.
- **Подія** (`Event`): Події життєвого циклу та події бази даних.

## Коли використовувати `Database` у плагінах

### Що варто робити на етапі `beforeLoad`

На цьому етапі операції з базою даних заборонені. Він підходить для реєстрації статичних класів або прослуховування подій.

- ``db.registerFieldTypes()` — для визначення власних типів полів`
- ``db.registerModels()` — для реєстрації власних класів моделей`
- ``db.registerRepositories()` — для реєстрації власних класів репозиторіїв`
- ``db.registerOperators()` — для реєстрації власних операторів фільтрації`
- ``db.on()` — для прослуховування подій, пов'язаних з базою даних`

### Що варто робити на етапі `load`

На цьому етапі вже завантажені всі попередні визначення класів та події, тому завантаження таблиць даних відбудеться без пропущених або відсутніх залежностей.

- ``db.defineCollection()` — для визначення нових таблиць даних`
- ``db.extendCollection()` — для розширення конфігурацій існуючих таблиць даних`

Якщо ви визначаєте вбудовані таблиці для плагіна, рекомендується розміщувати їх у каталозі `./src/server/collections`. Детальніше дивіться у розділі [Колекції](./collections.md).

## Операції з даними

Об'єкт `Database` надає два основні способи доступу та маніпуляції даними:

### Операції через `Repository`

```ts
const repo = db.getRepository('users');
const user = await repo.findOne({ filter: { id: 1 } });
```

Рівень репозиторію зазвичай використовується для інкапсуляції бізнес-логіки, такої як пагінація, фільтрація, перевірка дозволів тощо.

### Операції через `Model`

```ts
const UserModel = db.getModel('users');
const user = await UserModel.findByPk(1);
```

Рівень моделі безпосередньо відповідає сутностям ORM і підходить для виконання низькорівневих операцій з базою даних.

## На яких етапах дозволені операції з базою даних?

### Життєвий цикл плагіна

| Етап                | Дозволені операції з базою даних |
|---------------------|----------------------------------|
| `staticImport`      | Ні                               |
| `afterAdd`          | Ні                               |
| `beforeLoad`        | Ні                               |
| `load`              | Ні                               |
| `install`           | Так                              |
| `beforeEnable`      | Так                              |
| `afterEnable`       | Так                              |
| `beforeDisable`     | Так                              |
| `afterDisable`      | Так                              |
| `remove`            | Так                              |
| `handleSyncMessage` | Так                              |

### Події застосунку

| Етап                | Дозволені операції з базою даних |
|---------------------|----------------------------------|
| `beforeLoad`        | Ні                               |
| `afterLoad`         | Ні                               |
| `beforeStart`       | Так                              |
| `afterStart`        | Так                              |
| `beforeInstall`     | Ні                               |
| `afterInstall`      | Так                              |
| `beforeStop`        | Так                              |
| `afterStop`         | Ні                               |
| `beforeDestroy`     | Так                              |
| `afterDestroy`      | Ні                               |
| `beforeLoadPlugin`  | Ні                               |
| `afterLoadPlugin`   | Ні                               |
| `beforeEnablePlugin`| Так                              |
| `afterEnablePlugin` | Так                              |
| `beforeDisablePlugin`| Так                              |
| `afterDisablePlugin`| Так                              |
| `afterUpgrade`      | Так                              |

### Події/хуки бази даних

| Етап                          | Дозволені операції з базою даних |
|-------------------------------|----------------------------------|
| `beforeSync`                  | Ні                               |
| `afterSync`                   | Так                              |
| `beforeValidate`              | Так                              |
| `afterValidate`               | Так                              |
| `beforeCreate`                | Так                              |
| `afterCreate`                 | Так                              |
| `beforeUpdate`                | Так                              |
| `afterUpdate`                 | Так                              |
| `beforeSave`                  | Так                              |
| `afterSave`                   | Так                              |
| `beforeDestroy`               | Так                              |
| `afterDestroy`                | Так                              |
| `afterCreateWithAssociations` | Так                              |
| `afterUpdateWithAssociations` | Так                              |
| `afterSaveWithAssociations`   | Так                              |
| `beforeDefineCollection`      | Ні                               |
| `afterDefineCollection`       | Ні                               |
| `beforeRemoveCollection`      | Ні                               |
| `afterRemoveCollection`       | Ні                               |